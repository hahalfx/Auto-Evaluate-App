# 重复检查功能测试指南

## 测试目标
验证任务包导入中的智能重复检查功能，确保基于文本和音频文件路径的重复判断正确工作，并且重复检查已集成到导入流程中。

## 测试环境准备

### 1. 准备测试数据
创建以下测试任务包结构：
```
test_package/
├── 唤醒词语料列表.xlsx
├── 测试语料列表.xlsx
└── audio/
    ├── wakeword/
    │   ├── wake1.wav
    │   ├── wake2.wav
    │   └── wake3.wav
    └── samples/
        ├── sample1.wav
        ├── sample2.wav
        └── sample3.wav
```

### 2. Excel文件内容

**唤醒词语料列表.xlsx:**
| 文件名 | 语料名 |
|--------|--------|
| wake1.wav | 小度小度 |
| wake2.wav | 你好小度 |
| wake3.wav | 小度小度 |

**测试语料列表.xlsx:**
| 文件名 | 语料名 |
|--------|--------|
| sample1.wav | 打开音乐 |
| sample2.wav | 关闭音乐 |
| sample3.wav | 打开音乐 |

## 测试场景

### 场景1：完全重复检查
1. **初始状态**：数据库中已有唤醒词"小度小度"（音频文件：wake1.wav）
2. **导入任务包**：包含相同的"小度小度"（音频文件：wake1.wav）
3. **预期结果**：
   - 预检查显示：1个重复唤醒词
   - 导入结果：使用现有ID，不创建新记录
   - 统计：创建0个，忽略1个

### 场景2：部分重复检查
1. **初始状态**：数据库中已有测试语料"打开音乐"（音频文件：sample1.wav）
2. **导入任务包**：包含相同的"打开音乐"（音频文件：sample3.wav）
3. **预期结果**：
   - 预检查显示：1个新测试语料
   - 导入结果：创建新记录（因为音频文件路径不同）
   - 统计：创建1个，忽略0个

### 场景3：无音频文件重复检查
1. **初始状态**：数据库中已有唤醒词"你好小度"（无音频文件）
2. **导入任务包**：包含相同的"你好小度"（无音频文件）
3. **预期结果**：
   - 预检查显示：1个重复唤醒词
   - 导入结果：使用现有ID，不创建新记录
   - 统计：创建0个，忽略1个

### 场景4：混合场景测试
1. **初始状态**：数据库中有部分数据
2. **导入任务包**：包含新数据、重复数据、部分重复数据
3. **预期结果**：
   - 预检查正确识别各种情况
   - 导入结果符合预期
   - 统计数字准确

## 测试步骤

### 1. 导入功能测试（包含重复检查）
1. 打开任务创建页面
2. 选择"导入任务包"模式
3. 输入任务名称
4. 点击"导入任务包"按钮
5. 选择测试任务包文件夹
6. 验证导入结果：
   - 成功创建任务
   - 显示重复检查统计
   - 数据库中记录正确

### 3. 数据库验证
1. 检查wake_words表：
   - 重复数据使用现有ID
   - 新数据创建新记录
   - 音频文件路径正确保存

2. 检查test_samples表：
   - 重复数据使用现有ID
   - 新数据创建新记录
   - 音频文件路径正确保存

3. 检查task_wake_words表：
   - 关联关系正确
   - 重复数据指向现有ID

4. 检查task_samples表：
   - 关联关系正确
   - 重复数据指向现有ID

## 预期结果

### 成功标准
1. **导入功能**：
   - 正确处理各种重复情况
   - 避免数据冗余
   - 保持数据完整性
   - 显示准确的重复检查统计

3. **路径处理**：
   - 正确规范化文件路径
   - 支持不同操作系统
   - 处理中文路径

### 错误处理
1. **文件不存在**：显示警告但不阻止导入
2. **路径错误**：显示具体错误信息
3. **Excel格式错误**：显示格式要求说明

## 测试数据示例

### 测试用例1：完全重复
```sql
-- 初始数据
INSERT INTO wake_words (text, audio_file) VALUES ('小度小度', '/path/to/wake1.wav');

-- 导入相同数据后，应该使用现有ID
-- 预期：wake_words表仍只有1条记录
```

### 测试用例2：部分重复
```sql
-- 初始数据
INSERT INTO test_samples (text, audio_file) VALUES ('打开音乐', '/path/to/sample1.wav');

-- 导入相同文本但不同路径的数据后
-- 预期：test_samples表有2条记录
-- 1. '打开音乐' - '/path/to/sample1.wav'
-- 2. '打开音乐' - '/path/to/sample3.wav'
```

## 性能测试

### 大数据量测试
1. **准备数据**：创建包含1000个唤醒词和1000个测试语料的任务包
2. **执行测试**：
   - 测量预检查时间
   - 测量导入时间
   - 验证内存使用情况

### 重复率测试
1. **高重复率**：90%的数据与现有数据重复
2. **低重复率**：10%的数据与现有数据重复
3. **无重复**：所有数据都是新的

## 边界情况测试

1. **空文件**：Excel文件为空
2. **格式错误**：Excel文件格式不正确
3. **路径特殊字符**：包含中文、空格、特殊字符的路径
4. **大文件**：音频文件很大（>100MB）
5. **网络路径**：UNC路径或网络驱动器路径

## 自动化测试建议

### 单元测试
```rust
#[test]
fn test_duplicate_check_wake_words() {
    // 测试唤醒词重复检查逻辑
}

#[test]
fn test_duplicate_check_samples() {
    // 测试测试语料重复检查逻辑
}

#[test]
fn test_path_normalization() {
    // 测试路径规范化功能
}
```

### 集成测试
```rust
#[tokio::test]
async fn test_task_package_import() {
    // 测试完整的任务包导入流程
}
```

## 测试报告模板

### 测试结果记录
| 测试场景 | 预期结果 | 实际结果 | 状态 | 备注 |
|----------|----------|----------|------|------|
| 完全重复 | 使用现有ID | ✅ | 通过 | |
| 部分重复 | 创建新记录 | ✅ | 通过 | |
| 无音频文件 | 使用现有ID | ✅ | 通过 | |
| 导入时重复检查 | 显示正确统计 | ✅ | 通过 | |

### 性能指标
- 预检查时间：< 5秒（1000条数据）
- 导入时间：< 30秒（1000条数据）
- 内存使用：< 100MB

### 问题记录
- 问题1：[描述]
- 解决方案：[描述]
- 状态：[已解决/待解决] 